@model IEnumerable<CoolCareSystem.Models.ServiceModel>

@{
    ViewBag.Title = "Services";
}

<p class="title1">New Request</p>

<div class="row">
    <label class="col-md-3">Product Name</label>
    <div class="col-md-6">
        @(Html.DevExtreme().TextBox()
        .ID("txtProduct")
        .Placeholder("Enter Product Name")
        .Width("100%"))
    </div>
</div>
<br />
<div class="row">
    <label class="col-md-3">Service Issue</label>
    <div class="col-md-6">
        @(Html.DevExtreme().TextArea()
        .ID("txtServiceIssue")
        .Placeholder("Enter Service Issue")
        .Width("100%"))
    </div>
</div>
<br />
<div>
    <label class="col-md-3"></label>
    <button class="btn btn-xs btn-primary" id="btnNewRequest">New Request</button>
</div>
<br />
<div class="alert-note">
    <p class="alert alert-success alert-message ajaxMsg4">
        Service Requested
    </p>
    <p class="alert alert-warning alert-message ajaxMsg2">
        Give Proper Details
    </p>
</div>
<p class="title1">My Requests</p>
<div id="UserService">
    @(Html.DevExtreme().DataGrid()
    .ID("userServiceGridContainer")
    .DataSource(Model)
    .RowAlternationEnabled(true)
    .RepaintChangesOnly(true)
    .StateStoring(s => s.Enabled(true).Type(StateStoringType.LocalStorage).StorageKey("ServiceUser"))
    .Export(e => e.Enabled(true).AllowExportSelectedData(true))
    .SearchPanel(s => s.Visible(true).HighlightCaseSensitive(true))
    .AllowColumnReordering(true)
    .ShowBorders(true)
    .ColumnAutoWidth(true)
    .Grouping(g => g.AutoExpandAll(true))
    .Pager(p => p.ShowPageSizeSelector(true).AllowedPageSizes(new[] { 5, 10, 20 }))
    .Paging(p => p.PageSize(10))
    .GroupPanel(g => g.Visible(true).EmptyPanelText("Drag a column"))
    .Sorting(s => s.Mode(GridSortingMode.Multiple))
    .ColumnChooser(c => c.Enabled(true).Mode(GridColumnChooserMode.Select))
    .ShowColumnLines(true)
    .Columns(columns =>
    {
    columns.Add()
            .DataField("Id")
            .Caption("Id")
            .Alignment(HorizontalAlignment.Left);
    columns.Add()
            .DataField("ProductName");
    columns.Add()
            .DataField("Service_Issue");
    columns.Add()
            .DataField("RequestedAt");
    columns.Add()
            .DataField("IsApproved")
            .CellTemplate(@<text>
                <% if(value) { %>
                <span><i class="glyphicon glyphicon-ok"></i></span>
                <% }else{ %>
                <span><i class="glyphicon glyphicon-remove"></i></span>
                <% }%>
            </text>);
        columns.Add()
            .DataField("Status")
            .Caption("Is Closed")
            .CellTemplate(@<text>
                    <% if(value=='Closed') { %>
                        <span><i class="glyphicon glyphicon-ok"></i></span>
                    <% }else{ %>
                        <span><i class="glyphicon glyphicon-remove"></i></span>
                    <% }%>

        </text>);
        columns.Add()
            .DataField("Status")
            .Caption("Status & Rating")
            .CellTemplate(@<text>
                    <% if(data.IsApproved && data.Status == "Closed" && data.Rating >0) { %>
                        <a href="@Html.Raw(Url.Action("ServiceDetails", "UserService"))?Id=<%= data.Id %>" class="btn btn-xs btn-primary btnStatus">Status</a>
                    <% }else if(data.IsApproved && data.Status != "Closed" && data.Rating == 0){ %>
                        <a href="@Html.Raw(Url.Action("ServiceDetails", "UserService"))?Id=<%= data.Id %>" class="btn btn-xs btn-primary btnStatus">Status</a>
                    <% }else if(!data.IsApproved && data.Status != "Closed" && data.Rating == 0){ %>
                        <a href="@Html.Raw(Url.Action("ServiceDetails", "UserService"))?Id=<%= data.Id %>" class="btn btn-xs btn-primary disabled">Not Approved</a>
                    <% }else if(data.IsApproved && data.Status == "Closed" && data.Rating == 0){ %>
                        <button class="btn btn-xs btn-primary btnRate" id="<%= data.Id %>" onclick="rateServiceOnclick(this)">Rate The Service</button>
                        <div data-serviceid="<%= data.Id %>" id="star_div_<%= data.Id %>" class="starDiv hidden">
                            <span><i id="1" class="glyphicon star glyphicon-star-empty"></i></span>
                            <span><i id="2" class="glyphicon star glyphicon-star-empty"></i></span>
                            <span><i id="3" class="glyphicon star glyphicon-star-empty"></i></span>
                            <span><i id="4" class="glyphicon star glyphicon-star-empty"></i></span>
                            <span><i id="5" class="glyphicon star glyphicon-star-empty"></i></span>
                        </div>
                    <% }%>

        </text>);

    })
    )
</div>
<br>
<div class="alert-note">
    <p class="alert alert-success alert-message ajaxMsg">
        Rating Done
    </p>
</div>
<br />

@section Scripts {
    <script>
        $(function () {
            $("button#btnNewRequest").click(function (e) {
                e.preventDefault();
                var productName = $("#txtProduct").dxTextBox("instance").option("value");
                var serviceIssue = $("#txtServiceIssue").dxTextArea("instance").option("value");
                if (productName.length < 3 || serviceIssue.length < 3) {
                    $("p.ajaxMsg2").addClass("divInline");
                    setTimeout(function () {
                        $("p.ajaxMsg2").fadeOut("fast");
                        $("p.ajaxMsg2").removeClass("divInline");
                    }, 1000);
                }
                else {
                    var url1 = "/UserService/InsertService";
                    $.get(url1, { Name: productName, Issue: serviceIssue }, function (data) {
                        var status = data
                    }).done(function () {
                        $("p.ajaxMsg4").addClass("divInline");
                        setTimeout(function () {
                            $("p.ajaxMsg4").fadeOut("fast");
                            $("p.ajaxMsg4").removeClass("divInline");
                        }, 1000);
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    });
                }
            })
        });
        function rateServiceOnclick(e) {
            var Id = $(e).attr("id");
            $(e).addClass("hidden");
            $("#star_div_" + Id).removeClass("hidden");
            $(".btnRate,.btnStatus").addClass("disabled");
            $(".star").mouseenter(function () {
                var Id = $(this).attr("Id")
                $("i.star").removeClass("glyphicon-star");
                $("i.star").addClass("glyphicon-star-empty");
                for (var i = 1; i <= Id; i++) {
                    if ($("i#" + i + ".star").hasClass("glyphicon-star-empty")) {
                        $("i#" + i + ".star").removeClass("glyphicon-star-empty");
                        $("i#" + i + ".star").addClass("glyphicon-star");
                    }
                }
            })


            $(".starDiv").mouseleave(function () {
                $("i.star").removeClass("glyphicon-star");
                $("i.star").addClass("glyphicon-star-empty");
            })

            $("i.star").click(function (e) {
                e.preventDefault();
                var ServiceId = $(this).parent().parent().attr("data-serviceId");
                var Rating = $(this).attr("id");
                var url = "/UserService/RateService";
                $.get(url, { id: ServiceId, Rating: Rating }, function (data) {
                    var status = data
                }).done(function () {
                    $("p.ajaxMsg").addClass("divInline");
                    setTimeout(function () {
                        $("p.ajaxMsg").fadeOut("fast");
                        $("p.ajaxMsg").removeClass("divInline");
                    }, 1000);
                    setTimeout(function () {
                        location.reload();
                    }, 1000);
                });
            });
        }
    </script>

}
